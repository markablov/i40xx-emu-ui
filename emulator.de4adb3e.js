!function(){function s(s,t,e){if(!t.has(s))throw new TypeError("attempted to "+e+" private field on non-instance");return t.get(s)}function t(s,t){return t.get?t.get.call(s):t.value}function e(e,i){return t(e,s(e,i,"get"))}function i(s,t){if(t.has(s))throw new TypeError("Cannot initialize the same private elements twice on an object")}function r(s,t,e){i(s,t),t.set(s,e)}function a(s,t,e){if(t.set)t.set.call(s,e);else{if(!t.writable)throw new TypeError("attempted to set read only private field");t.value=e}}function c(t,e,i){return a(t,s(t,e,"set"),i),i}function n(s,t,e){if(!t.has(s))throw new TypeError("attempted to get private field on non-instance");return e}function h(s,t){i(s,t),t.add(s)}function o(s,t,e){return t in s?Object.defineProperty(s,t,{value:e,enumerable:!0,configurable:!0,writable:!0}):s[t]=e,s}const l=Symbol("cpu/pins/SYNC"),u=Symbol("cpu/pins/CM_ROM0"),g=Symbol("cpu/pins/CM_ROM1"),p=Symbol("cpu/pins/CM_RAM0"),k=Symbol("cpu/pins/CM_RAM1"),d=Symbol("cpu/pins/CM_RAM2"),b=Symbol("cpu/pins/CM_RAM3"),f=Symbol("cpu/pins/D0"),w=Symbol("cpu/pins/D1"),m=Symbol("cpu/pins/D2"),y=Symbol("cpu/pins/D3");var v=new WeakMap;var D=class{setPin(s,t){e(this,v)[s]=t?1:0}setPinsData(s,t){for(const[i,r]of s.entries())e(this,v)[r]=t&1<<i?1:0}getPin(s){return e(this,v)[s]}getPinsData(s){return s.reduce(((s,t,i)=>e(this,v)[t]?s|1<<i:s),0)}constructor(){r(this,v,{writable:!0,value:{[l]:0,[u]:1,[g]:0,[p]:0,[k]:0,[d]:0,[b]:0,[f]:0,[w]:0,[m]:0,[y]:0}})}};var P=class{isAddressValid(s){return s>=0&&s<this.banks[this.selectedBank].length}loadDump(s){this.banks=s}tick(){if(this.cpu.getPin(l))this.state=0;else{switch(this.state){case 0:this.address=this.cpu.getPinsData([f,w,m,y]);break;case 1:this.address|=this.cpu.getPinsData([f,w,m,y])<<4;break;case 2:if(this.address|=this.cpu.getPinsData([f,w,m,y])<<8,this.selectedBank=1===this.cpu.getPin(g)?1:0,!this.isAddressValid(this.address))throw`Address ${this.address} is not valid`;this.cpu.setPinsData([f,w,m,y],this.banks[this.selectedBank][this.address]>>4);break;case 3:this.cpu.setPinsData([f,w,m,y],15&this.banks[this.selectedBank][this.address])}this.state++}}constructor(s){o(this,"state",0),o(this,"address",0),o(this,"banks",[new Uint8Array(0),new Uint8Array(0)]),o(this,"selectedBank",0),this.cpu=s}};function M(s,t){if(s!==t)throw new TypeError("Private static access of wrong provenance")}function S(s,t,e){return M(s,t),e}var R=new WeakMap,C=new WeakMap,W=new WeakSet,A=new WeakSet;class O{static getBankNoFromPinsData(s){if(1==(1&s))return 0;switch(s>>=1){case 1:return 1;case 2:return 2;case 4:return 3;case 3:return 4;case 5:return 5;case 6:return 6;case 7:return 7;default:throw Error("Unknown value for CMRAM!")}}tick(){if(e(this,R).getPin(l)||7===this.state)return this.bankToSetOffset&&(this.bankToSetOffset.selectedCharacter=e(this,R).getPinsData([f,w,m,y]),this.bankToSetOffset=null),void(this.state=0);switch(this.state){case 0:case 1:case 2:case 3:case 5:default:break;case 4:this.bankForExecution=n(this,W,E).call(this),this.bankForExecution&&(this.opa=e(this,R).getPinsData([f,w,m,y]));break;case 6:{const s=e(this,R).getPinsData([f,w,m,y]);this.bankToSetOffset=n(this,W,E).call(this),this.bankToSetOffset&&(this.bankToSetOffset.selectedRegister=s),this.bankForExecution&&(n(this,A,x).call(this,this.bankForExecution,this.opa,s),this.bankForExecution=null);break}}this.state++}constructor(s,t,e){h(this,W),h(this,A),r(this,R,{writable:!0,value:void 0}),r(this,C,{writable:!0,value:void 0}),c(this,C,e),c(this,R,s),this.banks=S(O,O,B).call(O,t||S(O,O,T).call(O)),this.state=0}}function B(s){return s.map((s=>({registers:s,outputs:Array(4).fill(0),selectedRegister:0,selectedCharacter:0})))}function T(){return Array.from(Array(8),(()=>Array.from(Array(16),(()=>({main:Array(16).fill(0),status:Array(4).fill(0)})))))}function E(){const s=e(this,R).getPinsData([p,k,d,b]);return s?this.banks[O.getBankNoFromPinsData(s)]:null}function x(s,t,i){switch(t){case 9:case 11:case 8:e(this,R).setPinsData([f,w,m,y],s.registers[s.selectedRegister].main[s.selectedCharacter]);break;case 12:e(this,R).setPinsData([f,w,m,y],s.registers[s.selectedRegister].status[0]);break;case 13:e(this,R).setPinsData([f,w,m,y],s.registers[s.selectedRegister].status[1]);break;case 14:e(this,R).setPinsData([f,w,m,y],s.registers[s.selectedRegister].status[2]);break;case 15:e(this,R).setPinsData([f,w,m,y],s.registers[s.selectedRegister].status[3]);break;case 0:s.registers[s.selectedRegister].main[s.selectedCharacter]=i;break;case 1:(void 0)({chip:s.selectedRegister>>2,data:i}),s.outputs[s.selectedRegister>>2]=i;break;case 4:s.registers[s.selectedRegister].status[0]=i;break;case 5:s.registers[s.selectedRegister].status[1]=i;break;case 6:s.registers[s.selectedRegister].status[2]=i;break;case 7:s.registers[s.selectedRegister].status[3]=i}}var F=O;function _(s,t){if(t.set){if(!t.get)throw new TypeError("attempted to read set only private field");return"__destrWrapper"in t||(t.__destrWrapper={set value(e){t.set.call(s,e)},get value(){return t.get.call(s)}}),t.__destrWrapper}if(!t.writable)throw new TypeError("attempted to set read only private field");return t}function U(t,e){return _(t,s(t,e,"update"))}var N=new WeakMap,$=new WeakMap,V=new WeakMap,j=new WeakMap,H=new WeakSet,I=new WeakSet,z=new WeakSet,Y=new WeakSet,q=new WeakSet,G=new WeakSet,J=new WeakSet,K=new WeakSet,L=new WeakSet,Q=new WeakSet,X=new WeakSet;function Z(s){this.registers.stack[this.registers.sp]=s,this.registers.sp=(this.registers.sp+1)%7}function ss(){return this.registers.sp=(this.registers.sp-1+7)%7,this.registers.stack[this.registers.sp]}function ts(s,t=!1){const e=this.registers.acc+s+(t?0:this.registers.carry);this.registers.acc=15&e,this.registers.carry=+(e>15)}function es(s,t=!1){this.registers.carry=t?1:1&~this.registers.carry,n(this,z,ts).call(this,15&~s)}function is(s,t){return(3840&this.registers.pc)+(255==(255&this.registers.pc)?256:0)|s<<4|t}function rs(s){return this.registers.indexBanks[this.registers.selectedRegisterBank][s]}function as(s,t){if(s<8)this.registers.indexBanks[this.registers.selectedRegisterBank][s]=t;else for(const e of this.registers.indexBanks)e[s]=t}function cs(s,t){const{opa:e,opr:i,pc:r}=this.previousOp;switch(i){case 3:return 1==(1&e)?0:(n(this,J,as).call(this,e,s),n(this,J,as).call(this,e+1,t),r+1);case 4:return e<<8|s<<4|t;case 5:return n(this,H,Z).call(this,this.registers.pc+1),e<<8|s<<4|t;case 1:{const i=8==(8&e),r=2==(2&e),a=4==(4&e)&&0===this.registers.acc||r&&1===this.registers.carry;return(i?!a:a)?n(this,q,is).call(this,s,t):this.registers.pc+1}case 7:{const i=n(this,G,rs).call(this,e)+1&15;return n(this,J,as).call(this,e,i),0===i?this.registers.pc+1:n(this,q,is).call(this,s,t)}case 2:return 1==(1&e)?0:(n(this,J,as).call(this,e,s),n(this,J,as).call(this,e+1,t),this.registers.pc+1);default:return 0}}function ns(s,t){if(this.halted)return this.registers.pc;switch(s){case 0:switch(t){case 0:break;case 1:this.halted=!0;break;case 4:this.registers.acc|=n(this,G,rs).call(this,4);break;case 5:this.registers.acc|=n(this,G,rs).call(this,5);break;case 6:this.registers.acc&=n(this,G,rs).call(this,6);break;case 7:this.registers.acc&=n(this,G,rs).call(this,7);break;case 8:c(this,V,{targetCycle:e(this,j).instructionCycles+2n,bankNo:0});break;case 9:c(this,V,{targetCycle:e(this,j).instructionCycles+2n,bankNo:1});break;case 10:this.registers.selectedRegisterBank=0;break;case 11:this.registers.selectedRegisterBank=1;break;default:throw"Unknown instruction"}break;case 13:this.registers.acc=t;break;case 10:this.registers.acc=n(this,G,rs).call(this,t);break;case 11:{const s=this.registers.acc;this.registers.acc=n(this,G,rs).call(this,t),n(this,J,as).call(this,t,s);break}case 8:n(this,z,ts).call(this,n(this,G,rs).call(this,t));break;case 9:n(this,Y,es).call(this,n(this,G,rs).call(this,t));break;case 6:n(this,J,as).call(this,t,n(this,G,rs).call(this,t)+1&15);break;case 12:return this.registers.acc=t,n(this,I,ss).call(this);case 3:{const s=0==(1&t)?0:14&t;return n(this,q,is).call(this,n(this,G,rs).call(this,s),n(this,G,rs).call(this,s+1))}case 2:1==(1&t)&&(e(this,N).setPinsData([f,w,m,y],n(this,G,rs).call(this,1+(14&t))),e(this,N).setPinsData([p,k,d,b],0));break;case 4:case 5:case 1:case 7:break;case 14:switch(t){case 9:case 12:case 13:case 14:case 15:this.registers.acc=e(this,N).getPinsData([f,w,m,y]);break;case 11:n(this,z,ts).call(this,e(this,N).getPinsData([f,w,m,y]));break;case 8:n(this,Y,es).call(this,e(this,N).getPinsData([f,w,m,y]))}break;case 15:switch(t){case 0:this.registers.acc=0,this.registers.carry=0;break;case 1:this.registers.carry=0;break;case 3:this.registers.carry=1&~this.registers.carry;break;case 10:this.registers.carry=1;break;case 4:this.registers.acc=15&~this.registers.acc;break;case 2:n(this,z,ts).call(this,1,!0);break;case 8:n(this,Y,es).call(this,1,!0);break;case 5:{const s=this.registers.carry;this.registers.carry=this.registers.acc>>3,this.registers.acc=this.registers.acc<<1&15|s;break}case 6:{const s=this.registers.carry;this.registers.carry=1&this.registers.acc,this.registers.acc=this.registers.acc>>1|s<<3;break}case 7:this.registers.acc=this.registers.carry,this.registers.carry=0;break;case 11:if(1===this.registers.carry||this.registers.acc>9){const s=this.registers.acc+6;this.registers.acc=15&s,s>15&&(this.registers.carry=1)}break;case 9:this.registers.acc=1===this.registers.carry?10:9,this.registers.carry=0;break;case 12:switch(this.registers.acc){case 0:this.registers.acc=0;break;case 1:this.registers.acc=1;break;case 2:this.registers.acc=2;break;case 4:this.registers.acc=3;break;case 8:this.registers.acc=4;break;default:this.registers.acc=15}break;case 13:{const s=7&this.registers.acc;this.registers.ramControl=0===s?1:s<<1;break}default:throw"Unknown instruction"}break;default:throw"Unknown instruction"}return this.registers.pc+1}function hs(s,t){if(!this.isExecutingTwoCycleOperation()&&!this.halted&&2===s)1==(1&t)&&(e(this,N).setPinsData([f,w,m,y],n(this,G,rs).call(this,14&t)),e(this,N).setPinsData([p,k,d,b],this.registers.ramControl))}function os(s,t){if(!this.isExecutingTwoCycleOperation()&&!this.halted&&14===s)switch(t){case 0:case 1:case 4:case 5:case 6:case 7:e(this,N).setPinsData([f,w,m,y],this.registers.acc)}}var ls=class{isExecutingTwoCycleOperation(){return!!this.previousOp&&(!![4,5,1,7].includes(this.previousOp.opr)||[3,2].includes(this.previousOp.opr)&&0==(1&this.previousOp.opa))}get pins(){return e(this,N)}tick(){switch(e(this,$)){case 0:if(void 0!==this.opr)if(this.isExecutingTwoCycleOperation())this.registers.pc=n(this,K,cs).call(this,this.opr,this.opa),this.previousOp=null;else{const s=this.registers.pc;this.registers.pc=n(this,L,ns).call(this,this.opr,this.opa),this.previousOp={opa:this.opa,opr:this.opr,pc:s}}e(this,V)?.targetCycle===e(this,j).instructionCycles&&(this.registers.selectedRomBank=e(this,V).bankNo,c(this,V,null)),e(this,N).setPin(l,1);break;case 1:e(this,N).setPin(l,0),e(this,N).setPinsData([f,w,m,y],15&this.registers.pc);break;case 2:e(this,N).setPinsData([f,w,m,y],(240&this.registers.pc)>>4);break;case 3:e(this,N).setPinsData([f,w,m,y],(3840&this.registers.pc)>>8),e(this,N).setPinsData([u,g],1===this.registers.selectedRomBank?2:1);break;case 4:this.opr=e(this,N).getPinsData([f,w,m,y]);break;case 5:14!==this.opr||this.isExecutingTwoCycleOperation()||e(this,N).setPinsData([p,k,d,b],this.registers.ramControl),this.opa=e(this,N).getPinsData([f,w,m,y]),e(this,N).setPinsData([u,g],0);break;case 6:e(this,N).getPinsData([p,k,d,b])&&e(this,N).setPinsData([p,k,d,b],0),n(this,X,os).call(this,this.opr,this.opa);break;case 7:n(this,Q,hs).call(this,this.opr,this.opa),c(this,$,-1)}U(this,$).value++}constructor(s){h(this,H),h(this,I),h(this,z),h(this,Y),h(this,q),h(this,G),h(this,J),h(this,K),h(this,L),h(this,Q),h(this,X),o(this,"halted",!1),o(this,"registers",{acc:0,carry:0,indexBanks:[Array.from(Array(16),(()=>0)),Array.from(Array(16),(()=>0))],pc:0,ramControl:1,selectedRomBank:0,selectedRegisterBank:0,sp:0,stack:Array.from(Array(7),(()=>0))}),r(this,N,{writable:!0,value:void 0}),r(this,$,{writable:!0,value:0}),r(this,V,{writable:!0,value:null}),r(this,j,{writable:!0,value:void 0}),c(this,N,new D),c(this,j,s)}},us=new WeakMap,gs=new WeakMap,ps=new WeakMap,ks=new WeakMap,ds=new WeakMap,bs=new WeakSet,fs=new WeakSet;function ws(){e(this,us).tick(),e(this,gs).tick(),e(this,ps).tick()}function ms(){for(let s=0;s<8;s++)n(this,bs,ws).call(this);c(this,ds,e(this,ds)+1n)}var ys=class{instruction(){n(this,fs,ms).call(this),e(this,us).isExecutingTwoCycleOperation()&&!this.isFinished()&&n(this,fs,ms).call(this)}isFinished(){return e(this,ks)||!e(this,gs).isAddressValid(e(this,us).registers.pc)||e(this,us).halted}terminate(){c(this,ks,!0)}get registers(){return e(this,us).registers}get memory(){return e(this,ps).banks}get selectedRamBank(){return F.getBankNoFromPinsData(e(this,us).registers.ramControl)}get instructionCycles(){return e(this,ds)}constructor({romDump:s,ramDump:t,ramOutputHandler:i}){h(this,bs),h(this,fs),r(this,us,{writable:!0,value:void 0}),r(this,gs,{writable:!0,value:void 0}),r(this,ps,{writable:!0,value:void 0}),r(this,ks,{writable:!0,value:!1}),r(this,ds,{writable:!0,value:0n}),c(this,us,new ls(this)),c(this,gs,new P(e(this,us).pins)),e(this,gs).loadDump(Array.isArray(s)?s:[s]),c(this,ps,new F(e(this,us).pins,t,(({chip:s,data:t})=>i?.({address:`${this.selectedRamBank}:${s}`,data:t,type:"RAM"})))),n(this,bs,ws).call(this)}};let vs,Ds=new Set;const Ps=()=>{postMessage({command:"state",ram:vs.memory,registers:vs.registers,selectedRamBank:vs.selectedRamBank})},Ms=()=>new Promise((s=>{setTimeout((()=>s()),0)})),Ss=1e5,Rs={breakpoints:({breakpoints:s})=>{Ds=s},continue:async()=>{let s=0;for(;!vs.isFinished();){if(vs.instruction(),Ds.has(`${vs.registers.selectedRomBank}:${vs.registers.pc}`))return void Ps();s++,s%Ss==0&&(await Ms(),s=0)}Ps(),postMessage({command:"finish"})},run:async({breakpoints:s,mode:t,ramDump:e,romDump:i})=>{if("debug"!==t&&"run"!==t)throw"Unknown emulator mode";if(Ds=s||new Set,vs=new ys({ramDump:e,ramOutputHandler:({address:s,data:t,type:e})=>postMessage({address:s,command:"IOOutput",data:t,type:e}),romDump:i}),Ps(),"run"===t){let s=0;for(;!vs.isFinished();)vs.instruction(),s++,s%Ss==0&&(await Ms(),s=0);Ps(),postMessage({command:"finish"})}},stepInto:()=>{vs.isFinished()?postMessage({command:"finish"}):(vs.instruction(),Ps())},stepOver:async()=>{const s=vs.registers.sp;if(vs.isFinished())postMessage({command:"finish"});else{vs.instruction();let t=0;for(;s!==vs.registers.sp;){if(vs.isFinished())return Ps(),void postMessage({command:"finish"});vs.instruction(),t++,t%Ss==0&&(await Ms(),t=0)}Ps()}},stop:()=>{vs.terminate(),postMessage({command:"finish"})}};onmessage=({data:{command:s,...t}})=>{try{if(!Rs[s])return void postMessage({command:s,error:"Unknown command"});Rs[s](t)}catch(t){postMessage({command:s,error:t.toString()})}}}();
//# sourceMappingURL=emulator.de4adb3e.js.map
